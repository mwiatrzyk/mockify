stages:
    - test
    - stage
    - deploy

before_script:
    - apt-get update -qy
    - apt-get install -y python3-pip
    - pip3 install -r requirements.txt

build_docs:
    stage: test
    script:
        - cd docs
        - make html

run_tests:
    stage: test
    script:
        - pytest

.build_package:
    script:
        - pip3 install twine
        - python3 setup.py sdist bdist_wheel

test_deploy:
    stage: stage
    extends: .build_package
    variables:
        TWINE_USERNAME: $TEST_PYPI_USER
        TWINE_PASSWORD: $TEST_PYPI_PASS
    script:
        - twine upload --repository-url https://test.pypi.org/legacy/ dist/*
    only:
        - tags
    except:
        - branches
