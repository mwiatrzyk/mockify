image: python:3.6-slim

stages:
    - test
    - stage
    - deploy

before_script:
    - pip install -r requirements.txt

build_docs:
    stage: test
    script:
        - apt-get update -qy
        - apt-get install make
        - cd docs
        - make html

run_tests:
    stage: test
    script:
        - pytest docs/ mockify/ tests/

test_deploy:
    stage: stage
    variables:
        TWINE_USERNAME: $TEST_PYPI_USER
        TWINE_PASSWORD: $TEST_PYPI_PASS
    script:
        - pip install twine
        - python setup.py sdist bdist_wheel
        - twine upload --repository-url https://test.pypi.org/legacy/ dist/*
    only:
        - tags
    except:
        - branches
