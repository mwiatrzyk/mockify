image: python:3.6-slim

stages:
    - test
    - stage
    - verify
    - deploy

before_script:
    - pip install -r requirements.txt

build_docs:
    stage: test
    script:
        - apt-get update -qy
        - apt-get install make
        - cd docs
        - make html

run_tests:
    stage: test
    script:
        - pytest docs/ mockify/ tests/

deploy_to_test_pypi:
    stage: stage
    variables:
        TWINE_USERNAME: $TEST_PYPI_USER
        TWINE_PASSWORD: $TEST_PYPI_PASS
    script:
        - pip install twine
        - python setup.py sdist bdist_wheel
        - twine upload --repository-url https://test.pypi.org/legacy/ dist/*
    only:
        - tags
    except:
        - branches

install_from_test_pypi:
    stage: verify
    script:
        - rm -rf mockify/
        - pip install --index-url https://test.pypi.org/simple/ mockify
        - pytest tests/
    only:
        - tags
    except:
        - branches

deploy_to_pypi:
    stage: deploy
    when: manual
    variables:
        TWINE_USERNAME: $PYPI_USER
        TWINE_PASSWORD: $PYPI_PASS
    script:
        - pip install twine
        - python setup.py sdist bdist_wheel
        - twine upload dist/*
    only:
        - tags
    except:
        - branches
